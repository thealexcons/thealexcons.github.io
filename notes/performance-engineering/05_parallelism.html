<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Multi-Core Systems and Parallelism - Performance Engineering Notes</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="01_intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="02_profiling.html"><strong aria-hidden="true">2.</strong> Profiling</a></li><li class="chapter-item expanded "><a href="03_modeling.html"><strong aria-hidden="true">3.</strong> Performance Modeling</a></li><li class="chapter-item expanded "><a href="04_efficiency.html"><strong aria-hidden="true">4.</strong> Writing Efficient Code</a></li><li class="chapter-item expanded "><a href="05_parallelism.html" class="active"><strong aria-hidden="true">5.</strong> Multi-Core Systems and Parallelism</a></li><li class="chapter-item expanded "><a href="06_device_performance.html"><strong aria-hidden="true">6.</strong> System and Device Performance</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Performance Engineering Notes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="lecture-5-multicore-systems-and--parallelism"><a class="header" href="#lecture-5-multicore-systems-and--parallelism">Lecture 5: Multicore Systems and  Parallelism</a></h1>
<p>This lecture is about scaling up and adding parallelism to our program to improve performance.</p>
<h2 id="background"><a class="header" href="#background">Background</a></h2>
<p>In 1974, an observation known as <strong>Dennard scaling</strong> says that <em>as transistors shrink, they become faster, consume less power and are cheaper</em>. However, due to physical and manufacturing limits, this observation ended in 2004.</p>
<p>On the other hand, <strong>Moore's Law</strong> is still true today (the number of transistors double every few years). To continue making good use of all these new transistors, we moved from single-core to multi-core in order to execute more instructions in parallel.</p>
<p>There are three forms of parallelism:</p>
<ul>
<li><strong>Data-level parallelism</strong>, such as vectorised instructions (SIMD).</li>
<li><strong>Instruction-level parallelism</strong>, via superscalar and out-of-order execution.</li>
<li><strong>Task-level parallelism</strong>, via threads, processes, GPU kernels...</li>
</ul>
<p>This lecture will focus on task-level parallelism: multithreading and multiprocessing.</p>
<p>Parallelism can be benefical for:</p>
<ol>
<li>Making an application <strong>faster</strong> (by breaking it down into parallel parts)</li>
<li>Making a system more <strong>cost-efficient</strong> (by sharing system resources or using multiple machines)</li>
</ol>
<h3 id="example-simple-cpu-provisioning"><a class="header" href="#example-simple-cpu-provisioning">Example: Simple CPU provisioning</a></h3>
<blockquote>
<p>Suppose a server with the following conditions:</p>
<ul>
<li>1 Gbps network card</li>
<li>1 request is 1 KB long</li>
<li>1 request takes 50 μs to process</li>
</ul>
<p>Calculate the number of CPUs needed to serve this in a single machine.</p>
</blockquote>
<details>
  <summary>Click to see the answer</summary>
<p>The key to answering this question is to look at the dimensions/units of each quantity. The number of CPUs has no unit, so we need the units to cancel out:</p>
<p>Units: bits/sec  *  sec  *  1/bits<br>
Calculation: (1e9) * (50e-6) * (1/8000) = 6.25  -&gt;  7 CPUs needed</p>
</details>
<h2 id="multithreading"><a class="header" href="#multithreading">Multithreading</a></h2>
<p>Threads are concurrent streams of execution and share memory within a process. We will explore threads in more detail next.</p>
<h3 id="performance-analysis"><a class="header" href="#performance-analysis">Performance analysis</a></h3>
<p>When analysing the performance of a multithreaded application, it is important to understand the <strong>critical path</strong> (<em>the sequence of tasks determining the minimum time needed for an operation</em>) and any potential <strong>dependencies</strong> on non-parallel sections of the code.</p>
<p>It is important to optimise non-parellel sections of code instead of parallel code, as it will take up the most time in the critical path.</p>
<p>For example, if we have a program with the following runtime, clearly it is more important to optimise <code>c()</code> because it is the bottleneck of the system:</p>
<img src="assets/05_critical_path.png">
<h3 id="communication-and-synchronisation"><a class="header" href="#communication-and-synchronisation">Communication and synchronisation</a></h3>
<p>We will describe four types of communication and synchronisation:</p>
<ol>
<li>
<p><strong>Explicit sharing</strong>: all threads share process memory and the hardware handles memory updates through cache coherency protocols. We need to ensure we do not have data races through <em>atomic operations</em>, <em>mutexes/critical sections</em>, <em>condition variables</em> and other primitives. See <em>Theory and Practice of Concurrency</em> notes for more details on synchronisation primitives.</p>
</li>
<li>
<p><strong>False sharing</strong>: when data is accessed, the entire cache line is brought into cache, so if one thread writes to some memory, the cache line it is contained in will be invalidated in any other cores and will require it to be reloaded. We can avoid this using alignment/padding.</p>
</li>
</ol>
<h3 id="thread-management-models"><a class="header" href="#thread-management-models">Thread management models</a></h3>
<p>We will look at different patterns and models for managing threads:</p>
<ol>
<li>
<p><strong>On-demand</strong>: spawn a new thread on-demand for individual jobs. </p>
<ul>
<li>✓ Very easy to implement </li>
<li>☒ Very expensive when the num. threads &gt; num. CPUs due to contention and scheduling.</li>
</ul>
</li>
<li>
<p><strong>Fork-join</strong>: spawn a new thread on-demand to process for batched jobs. </p>
<ul>
<li>✓ Effective when we are executing long computations in batches,</li>
<li>☒ Limited to a fork-join scope scenario where batched execution is actually useful.</li>
</ul>
</li>
<li>
<p><strong>Work dispatching (thread pools)</strong>: a job generator cycles through a worker thread pool. </p>
<ul>
<li>✓ Excellent for homogeneous jobs </li>
<li>☒ Can lead to imbalance of work among the workers threads, since it is event-driven.</li>
</ul>
</li>
<li>
<p><strong>Work stealing (thread pools)</strong>: workers pull pending jobs from a shared job queue as soon as it becomes free. </p>
<ul>
<li>✓ It avoids imbalance and therefore apt for heterogenous jobs</li>
<li>☒ Enqueueing/dequeuing might be costly (due to contention and cache coherency traffic). We can use <em>adaptive batching</em> (dequeuing batches of jobs at once) to reduce the cost.</li>
</ul>
</li>
<li>
<p><strong>Streaming (producer/consumer)</strong>: similar to an &quot;assembly line&quot; across threads: we create one thread per function, the job is enqueued into the first function's input job queue and each function enqueues their result into the next function's input queue. This mimicks the idea of CPU pipelining.</p>
</li>
<li>
<p><strong>Staged event-driven (SEDA)</strong>: the modular logic of a system are divided into stages containing in/out queues and a thread pool. It supports massively concurrent systems and dynamic control, however it can lead to perfomance loss due to rescheduling and/or no cache locality. Also, due to the pipeline nature, the sequential execution will be limited by the slowest part of the pipeline.</p>
</li>
</ol>
<img src="assets/05_seda.png">
<h2 id="multiprocessing"><a class="header" href="#multiprocessing">Multiprocessing</a></h2>
<p>Multiprocessing is different to multithreading in that there is no shared memory and communication must be performed explicitly through OS-level interfaces.</p>
<p>It is useful for streaming scenarios with fully independent tasks and for scalable distributed pipelines because we can easily scale out processes into multiple machines (used by Spark).</p>
<h3 id="communication"><a class="header" href="#communication">Communication</a></h3>
<p>Without implicit shared memory, communication is key for:</p>
<ul>
<li>Performance: need to consider syscall, scheduling and memory copy overheads</li>
<li>Programmability: not as easy to call a function in another task (need to consider serialisation of data)</li>
</ul>
<p>Some solutions are:</p>
<ul>
<li>Explicit shared memory</li>
<li>Sockets</li>
<li>Pipes</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="04_efficiency.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="06_device_performance.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="04_efficiency.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="06_device_performance.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3000/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
