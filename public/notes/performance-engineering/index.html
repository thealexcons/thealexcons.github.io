<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Introduction - Performance Engineering Notes</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="01_intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="02_profiling.html"><strong aria-hidden="true">2.</strong> Profiling</a></li><li class="chapter-item expanded "><a href="03_modeling.html"><strong aria-hidden="true">3.</strong> Performance Modeling</a></li><li class="chapter-item expanded "><a href="04_efficiency.html"><strong aria-hidden="true">4.</strong> Writing Efficient Code</a></li><li class="chapter-item expanded "><a href="05_parallelism.html"><strong aria-hidden="true">5.</strong> Multi-Core Systems and Parallelism</a></li><li class="chapter-item expanded "><a href="06_device_performance.html"><strong aria-hidden="true">6.</strong> System and Device Performance</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Performance Engineering Notes</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="lecture-1-introduction"><a class="header" href="#lecture-1-introduction">Lecture 1: Introduction</a></h1>
<p>Systems are made up from <strong>components</strong> that interact to achieve a greater goal. They are usually applicable to different problems and domains, rather than HPC, which focuses on a single problem of high value.</p>
<p><strong>Flexibility is key</strong> in a system: the exact conditions under which a system operates are unknown at development time.</p>
<p>For example:</p>
<ul>
<li>A Data management system does not know the data format/schema beforehand</li>
<li>Grep does not know what regex to search for</li>
</ul>
<p>In addition, software systems need to be <strong>maintainable</strong> because of how complex they are due to many years of development.</p>
<p>Finally, systems should be <strong>fast</strong>: a faster system is generally better than a slower system.</p>
<p>The <strong>challenge is to build a system which is balanced enough where it is maintainable, flexible and fast</strong>.</p>
<h2 id="live-coding-session"><a class="header" href="#live-coding-session">Live coding session</a></h2>
<p>Write a program that counts the lines of a text file containing the phrase <code>  FAUST:</code>.</p>
<p>1 - We first build a functional version:</p>
<pre><code class="language-c++">// Interface
class Operator {
public:
    virtual char const* getNextString() = 0;
};

// Read an array one time
class ArrayReader : public Operator {
private:
    char const* inputArray;
    bool isRead{false};

public:
    ArrayReader(char const* array) : inputArray(array) {}

    char const* getNextString() override {
        if (isRead) {
            return nullptr;
        }
        isRead = true;
        return inputArray;
    }
};

class LineSeparator : public Operator {
private:
    Operator&amp;&amp; input;
    char const* currentString{nullptr};

public:
    LineSeparator(Operator&amp;&amp; input) : input(std::move(input)) {}

    char const* getNextString() override {
        if (currentString == nullptr) {
            currentString = input.getNextString();
        }

        auto result = currentString;

        // Advance until the next string for later calls
        if (currentString != nullptr) {
            while (*currentString != '\n' &amp;&amp; *currentString != '\0') {
                currentString++;
            }

            if (*currentString == '\n') {
                currentString++;
            } else if (*currentString == '\0') {
                return nullptr;
            }
        }

        return result;
    }
};

class LineMatcher : public Operator {
private:
    Operator&amp;&amp; input;
    char const* currentString{nullptr};

public:
    LineMatcher(Operator&amp;&amp; input) : input(std::move(input)) {}

    char const* getNextString() override {
        auto candidate = input.getNextString();
        while (candidate != nullptr) {
            // try to match with our target string
            if (candidate[0] == ' ' &amp;&amp;
                candidate[1] == 'F' &amp;&amp;
                ...) {
                    return candidate;
                }

            candidate = input.getNextString();
        }

        return nullptr;
    }

};

class LineCounter {
private:
    Operator&amp;&amp; input;
public:
    LineCounter(Operator&amp;&amp; input) : input(std::move(input)) {}

    unsigned long getCount() {
        unsigned long count = 0;
        auto line = input.getNextString();
        while (line != nullptr) {
            count++;
            line = input.getNextString();
        }

        return result;
    }
};

int main(int argc, char *argv[]) {
    auto fd = open(argv[1], O_RDONLY);
    auto fsize = lseek(fd, 0, SEEK_END);
    lseek(fd, 0, SEEK_SET);

    auto data = (char*) mmap(nullptr, fsize, PROT_READ, MAP_SHARED, fd, 0);

    auto res = LineCounter(
        LineMatcher(
            LineSeparator(
                ArrayReader(data)
            )
        )
    ).getCount();

    printf(&quot;Count: %lu\n&quot;, res);
    return 0;
}
</code></pre>
<p>2 - If we benchmark our program using <code>time</code> and compare with <code>grep</code>, we see that our program is x4 slower (for large file sizes). Now, we try to run the string matching on the main function directly by comparing the bytes, instead of using all of the classes and OOP-style code.</p>
<p>3 - We should also try to compile with <code>-O3</code> optimisations, which gives us a good performance boost.</p>
<p>4 - We can improve the string matching loop by directly comparing an 8-byte word at a time:</p>
<pre><code class="language-c++">// Get the bit pattern of what we're looking for
long word = *((long *) &quot;  FAUST:&quot;);

for (auto i = 0; i &lt; fsize - 9; i++) {
    long currWord = *((long*)(data + i);
    if (currWord == word &amp;&amp; data[i+8] == '\n') {
        count++;
    }
}
</code></pre>
<p>This gives us a x2 speed increase compared to <code>grep</code>. <strong>This is what performance engineering is about</strong>: we first meet the functional requirements and then optimise for performance.</p>
<p><strong>Performance engineering</strong> is about the techniques applied during a systems development life cycle to ensure the non-functional requirements for performance will be met.</p>
<h2 id="when-to-stop-optimising"><a class="header" href="#when-to-stop-optimising">When to stop optimising?</a></h2>
<p>How do we know when to stop optimising? How fast is <em>fast enough</em>?</p>
<ol>
<li>
<p><strong>Define a target metric</strong>, for example:</p>
<ul>
<li>throughput (ops/s)</li>
<li>latency (s)</li>
<li>memory usage</li>
<li>scalability</li>
<li>etc.</li>
</ul>
</li>
<li>
<p><strong>Decide when the requirements are met</strong>, two options:</p>
<ul>
<li>Set an optimisation budget (in terms of developer time and/or salary)</li>
<li>Set an optimisation target/requirement (QoS), such as <em>real-time requirements</em>:
<ul>
<li><strong>Soft real-time-req</strong>: if missed, the software is <em>an error</em></li>
<li><strong>Hard real-time-req</strong>: if missed, the software is <em>a failure</em></li>
</ul>
</li>
</ul>
</li>
</ol>
<p>The latter type of requirement is known as a <strong>Quality-of-Service (QoS)</strong> objective, which is a statistical properties of a metric that shall hold for the system. For example:</p>
<blockquote>
<p>&quot;<em>The framerate of the game will, on average, be higher than 60 frames per second if run on a GPU with 50 GFlops or more.</em>&quot;</p>
</blockquote>
<p>QoS requirements can sometime conflict with functional requirements, so it is important to find the right balance.</p>
<p>A <strong>Service-Level Agreement (SLA)</strong> is a formal, legal contract specifying QoS objectives as well as penalties for violations of such objectives. For example:</p>
<blockquote>
<p>&quot;<em>Trading orders shall not exceed 1ms response time. In case of violation, the user is eligible for a 10% credit towards fees.</em>&quot;</p>
</blockquote>
<p>When defining SLAs and QoS objectives, you should be <em>SMART</em>:</p>
<ul>
<li>Specific: state exactly what is acceptable in numeric terms</li>
<li>Measurable: make sure what is stated can actually be measured</li>
<li>Acceptable: rigorous enough to guarantee success in reality</li>
<li>Realizable: lenient enough to allow implementation</li>
<li>Thorough: ensure that all necessary aspect of the system are specified</li>
</ul>
<h2 id="measuring-and-performance-evaluation"><a class="header" href="#measuring-and-performance-evaluation">Measuring and performance evaluation</a></h2>
<p>In this course, we will focus on <strong>measurability</strong> but there are different techniques:</p>
<ul>
<li><strong>Measuring</strong>:
<ul>
<li>Monitoring</li>
<li>Benchmarking</li>
</ul>
</li>
<li>Analytical Modeling</li>
<li>Simulation</li>
<li>Hybrid techniques:
<ul>
<li>Model, then simulate, then measure</li>
<li>etc.</li>
</ul>
</li>
</ul>
<p>Measuring is performed on the actual system, whether it is on a prototype or the final system. Measuring is often based on <em>instrumentation</em> and can achieve good accuracy, but it is often costly and can be difficult.</p>
<h3 id="monitoring"><a class="header" href="#monitoring">Monitoring</a></h3>
<p>Monitoring refers to <strong>measuring in production</strong>. Monitoring is actually <strong>required to enforce SLAs</strong> in order to:</p>
<ul>
<li>Observe system performance,</li>
<li>Collect statistics,</li>
<li>Analyze data,</li>
<li>Report SLA violations</li>
</ul>
<p>Monitoring can incur cost, as you may need to setup monitoring systems and can directly affect the performance of the workload. Hence, monitoring is often <strong>not continuous</strong>.</p>
<h3 id="benchmarking"><a class="header" href="#benchmarking">Benchmarking</a></h3>
<p>Benchmarking refers to &quot;<em>measuring in the lab</em>&quot;. It is a two-step process:</p>
<ol>
<li>Get the system into a predefined (or steady) state.</li>
<li>Perform a series of operations (the workload) while measuring relevant performance metric.</li>
</ol>
<p>For example, database workloads usually have a data generator to make the system load a dataset (i.e., predefined state) and a query set (the series of operations).</p>
<p>The benchmark workload should be representative of production workloads but smaller for easier benchmarking. They can be:</p>
<ul>
<li>
<p><strong>Batch workload</strong>: the program has access to the entire batch from the start, useful when the metric is <strong>throughput</strong>. Here, the work generator is unimportant.</p>
</li>
<li>
<p><strong>Interactive workload</strong>: work is generated randomly one at-a-time, useful when the metric is <strong>latency</strong>. The work generator should be as least as fast as the system, otherwise the system becomes under-utilised during the benchmark.</p>
</li>
</ul>
<h2 id="interpreting-results"><a class="header" href="#interpreting-results">Interpreting results</a></h2>
<p>A single measured datapoint is meaningless, due to the large amount of noise in modern computer systems. This is basic statistics: we need to aggregate multiple runs of the benchmark and report a measure of variance.</p>
<h2 id="optimisation-loop"><a class="header" href="#optimisation-loop">Optimisation loop</a></h2>
<img src="assets/01_optimisation_loop.png">
<p>A key part of this lifecycle is to <strong>identify optimisation opportunities</strong>.</p>
<p>A <strong>parameter</strong> is a system and workload characteristics that affect performance. This is purposely a broad definition, so we can categorise parameters into two types:</p>
<ul>
<li>
<p><strong>System Parameters</strong>: those that generally do not change while the system runs (caches, CPU instruction costs, ...)</p>
</li>
<li>
<p><strong>Workload Parameters</strong>: those that may change, even while the system is running (users, available memory, other processes...)</p>
</li>
</ul>
<p>We can also divide parameters based on the representation: <em>numerical parameters</em> (such as CPU frequency) or <em>nominal/categorical parameters</em> (such as the target device class).</p>
<p><strong>Utilisation</strong> is the percentage of a resource that is used to perform the service. Any service will have a certain amount of resources available (eg CPU cycles, memory capacity, network bandwidth). As such, the utilisation is a numeric parameter.</p>
<h3 id="bottlenecks"><a class="header" href="#bottlenecks">Bottlenecks</a></h3>
<p>Given this definition, a <strong>bottleneck</strong> is the resource with the highest utilisation. We use the term <em>x-bound</em> to indicate that <em>x</em> is the bottleneck of an application:</p>
<ul>
<li>CPU-bound -&gt; faster CPU needed</li>
<li>Disk/network bandwidth-bound -&gt; more disk/network bandwidth needed</li>
<li>etc.</li>
</ul>
<p>Unfortunately, <strong>identifying bottlenecks for an entire complex software system is practically infeasible</strong>. Instead, we should look at the <strong>performance-dominating</strong> code paths and dedicate our effort to optimising such paths.</p>
<p>Some paths have special names:</p>
<ul>
<li>
<p><strong>Critical path</strong>: the sequential part of the code in a parallel system, ie: the longest piece of sequential code needed to perform a particular service.</p>
</li>
<li>
<p><strong>Hot path</strong>: the path that takes the most time.</p>
</li>
</ul>
<h2 id="how-to-optimise"><a class="header" href="#how-to-optimise">How to optimise?</a></h2>
<p>The goal in optimisation is to:</p>
<ul>
<li>
<p>Compare alternative designs (development)</p>
</li>
<li>
<p>Select a close-to-optimal value for a platform parameter (tuning)</p>
</li>
</ul>
<p>The second strategy is known as <strong>parameter tuning</strong>, which is finding the vector in the parameter space that either:</p>
<ul>
<li>minimises resource consumption, or</li>
<li>maximises a performance metric</li>
</ul>
<p>This implies exploring the parameter space and can be quite expensive. We can build <em>analytical models</em> to accelerate this tuning process.</p>
<h3 id="analytical-performance-models"><a class="header" href="#analytical-performance-models">Analytical performance models</a></h3>
<p>An analytical performance model is a formal characterisation of the relationship between system parameters (hardware, software, data) and performance metrics.</p>
<p>The challenge is to model a dynamic system using a (reasonably small) static model.</p>
<p>Models can be stateless (eg., characterising equations, such as regression curves) or stateful (eg., markov chains), which are usually harder to implement but more accuarate.</p>
<p>Analytical models:</p>
<ul>
<li>are fast</li>
<li>they allow what-if-analysis (to estimate the change of a system/workload parameter)</li>
</ul>
<p>Models are key to defining the achievable performance requirements in an SLA.</p>
<p>Examples of analytical performance models are:</p>
<blockquote>
<p>Example 1: <em>An I/O bound application, that needs to read 40MB per request is limited to 10 requests per second when running on a hardware platform with a single disk providing 400MB/s bandwidth.</em></p>
</blockquote>
<blockquote>
<p>Example 2: <em>A compute-bound application that needs 3 cycles to process one byte is limited to 20 requests per second if it needs to process 40MB per request and the CPU runs at 2.4GHz.</em></p>
</blockquote>
<h3 id="simulation"><a class="header" href="#simulation">Simulation</a></h3>
<p>A simulation is a single observed run of a stateful model.</p>
<p>They can be extremely expensive to calculate especially if the level of detail is high.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->

                            <a rel="next" href="02_profiling.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

                    <a rel="next" href="02_profiling.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3000/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
